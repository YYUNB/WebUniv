<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>p1</title>
    <style>
        table {
            display: inline-block;
            border-collapse: collapse;
        }
        div {
            display: inline-block;
            justify-items: center;
        }
        td {
            border: 1px solid skyblue;
            background: lightgrey;
            width: 100px;
            height: 100px;
            text-align: center;
            font-size: 24px;
        }
    </style>
</head>
<body>
<h3 id="printTime"></h3>
<table id="table"></table>
<div id="scoreboard">
    <h3>Scoreboard</h3>
    <ul id="scoreList"></ul>
</div>
</body>
<script>
    window.onload = function() {
        showScore();
        init();
    };

    var card = [];
    var fClick = null, sClick = null;
    var timer, flowTime;
    var limit = 20;
    var start = false;
    var name, row, col;

    function init() {
        name = prompt("이름을 입력하세요.");
        row = parseInt(prompt("행을 입력하세요."));
        col = parseInt(prompt("열을 입력하세요."));

        document.getElementById("printTime").innerHTML = "Time left: " + limit + " seconds";

        setTable(row, col);
        setNumber(row, col);

        setTimeout(hideNumber, 3000);
        setTimeout(startTimer, 3000);
    }

    function setTable(r, c) {
        let table = document.getElementById('table');
        table.innerHTML = '';
        for (let i = 0; i < r; i++) {
            let tr = document.createElement('tr');
            for (let j = 0; j < c; j++) {
                var td = document.createElement('td');
                td.addEventListener('click', clickEvent);
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
    }

    function setNumber(r, c) {
        let size = r * c;
        let num = [];
        for (let i = 0; i < size / 2; i++) {
            num.push(i);
            num.push(i);
        }

        for (let i = num.length - 1; i > 0; i--) {
            let j = Math.floor(Math.random() * (i + 1));
            let temp = num[i];
            num[i] = num[j];
            num[j] = temp;
        }

        let td = document.getElementsByTagName('td');
        for (let i = 0; i < td.length; i++) {
            td[i].setAttribute('data-number', num[i]);
            td[i].innerHTML = num[i];
            card.push(num[i]);
        }
    }

    function hideNumber() {
        let td = document.getElementsByTagName('td');
        for (let i = 0; i < td.length; i++) td[i].innerHTML = '';
        start = true;
    }

    function startTimer() {
        let timeLeft = limit;
        flowTime = setInterval(function() {
            document.getElementById("printTime").innerHTML = "Time left: " + timeLeft + " seconds";
            timeLeft--;
            if (timeLeft < 0) {
                clearInterval(flowTime);
                lose();
            }
        }, 1000);
    }

    function clickEvent() {
        if (!start) return;
        let clickTd = this;

        if (fClick && sClick) return;
        clickTd.innerHTML = clickTd.getAttribute('data-number');
        if (!fClick) fClick = clickTd;
        else if (!sClick) {
            sClick = clickTd;
            if (fClick.getAttribute('data-number') === sClick.getAttribute('data-number')) {
                fClick.style.backgroundColor = 'lightgreen';
                sClick.style.backgroundColor = 'lightgreen';
                fClick = null;
                sClick = null;
                win();
            } else {
                setTimeout(function() {
                    fClick.innerHTML = '';
                    sClick.innerHTML = '';
                    fClick = null;
                    sClick = null;
                }, 500);
            }
        }
    }

    function win() {
        let td = document.getElementsByTagName('td');
        let cnt = 0;
        for (let i = 0; i < td.length; i++) if (td[i].style.backgroundColor === 'lightgreen') cnt++;

        if (cnt === td.length) {
            clearTimeout(timer);
            clearInterval(flowTime);
            const playTime = limit - parseInt(document.getElementById("printTime").textContent.split(' ')[2]);
            alert("모든 짝을 찾았습니다! 게임 승리! 걸린 시간: " + playTime + " 초");
            addScore(playTime);
        }
    }

    function addScore(playTime) {
        var scoreList = document.getElementById('scoreList');
        var li = document.createElement('li');
        li.innerHTML = name + ": " + playTime + "s, " + row + "x" + col;
        scoreList.appendChild(li);
        saveLocal(name, playTime, row, col);
        showScore();
    }

    function saveLocal(name, time, row, col) {
        var key = name;
        var newValue = time + "," + row + "," + col;
        var oldValue = localStorage.getItem(key);
        var storageArea = oldValue ? oldValue + '|' + newValue : newValue;
        localStorage.setItem(key, storageArea);
    }

    function showScore() {
        var scoreList = document.getElementById('scoreList');
        scoreList.innerHTML = '';
        var s = [];

        for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            var ss = localStorage.getItem(key).split('|');
            for (var j = 0; j < ss.length; j++) {
                var p = ss[j].split(',');
                var score = {};
                score.name = key;
                score.time = parseInt(p[0]);
                score.row = p[1];
                score.col = p[2];
                s.push(score);
            }
        }

        s.sort(function(a, b) { return a.time - b.time; });

        for (var i = 0; i < s.length; i++) {
            var li = document.createElement('li');
            li.innerHTML = s[i].name + ": " + s[i].time + "s, " + s[i].row + "x" + s[i].col;
            scoreList.appendChild(li);
        }
    }

    function resetGame() {
        card = [];
        fClick = null;
        sClick = null;
        clearTimeout(timer);
        clearInterval(flowTime);
        start = false;
        init();
    }

    function lose() {
        if (!start) return;
        alert("시간 초과! 게임 패배!");
        resetGame();
    }

</script>
</html>
